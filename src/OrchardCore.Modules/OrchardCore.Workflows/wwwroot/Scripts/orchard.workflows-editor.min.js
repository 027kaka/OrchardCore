var applyFilter=function(i,o){var a=$(".modal-activities").data("activity-type");i=i||$(".activity-picker-categories .nav-link.active").attr("href").substr(1),o=o||$(".modal-activities input[type=search]").val();var t=$(".activity.card").show();t.filter(function(t,e){return $(e).data("activity-type")!=a}).hide(),0<o.length?t.filter(function(t,e){return $(e).find(".card-title").text().toLowerCase().indexOf(o.toLowerCase())<0&&o&&0<o.length}).hide():t.filter(function(t,e){return $(e).data("category").toLowerCase()!=i.toLowerCase()&&"all"!=i.toLowerCase()}).hide(),$(".activity-picker-categories [data-category]").each(function(t,e){var i=$(e),o=i.data("category");0==$(".activity.card[data-category='"+o+"'][data-activity-type='"+a+"']").length?i.hide():i.show()})};$(function(){$(".activity-picker-categories").on("click",".nav-link",function(t){applyFilter($(t.target).attr("href").substr(1),null)}),$(".modal-activities input[type=search]").on("keyup",function(t){applyFilter(null,$(t.target).val())}),$("#activity-picker").on("show.bs.modal",function(t){var e=$(t.relatedTarget),i=e.data("picker-title"),o=e.data("activity-type"),a=$(this);a.find('[href="#all"]').click(),a.find(".modal-title").text(i),a.data("activity-type",o),applyFilter(null,null)})});var WorkflowCanvas=function(t,e){var s=this;this.container=t,this.workflowType=e,this.minCanvasHeight=400,this.getActivityElements=function(){return $(s.container).find(".activity")},this.getDefaults=function(){return{Anchor:"Continuous",DragOptions:{cursor:"pointer",zIndex:2e3},EndpointStyles:[{fillStyle:"#225588"}],Endpoints:[["Dot",{radius:7}],["Blank"]],ConnectionOverlays:[["Arrow",{width:12,length:12,location:-5}]],ConnectorZIndex:5}},this.createJsPlumbInstance=function(){return jsPlumb.getInstance({DragOptions:{cursor:"pointer",zIndex:2e3},ConnectionOverlays:[["Arrow",{location:1,visible:!0,width:11,length:11}],["Label",{location:.5,id:"label",cssClass:"connection-label"}]],Container:s.container})},this.getEndpointColor=function(t){return t.isBlocking||t.isStart?"#7ab02c":t.isEvent?"#3a8acd":"#7ab02c"},this.getSourceEndpointOptions=function(t,e){var i=s.getEndpointColor(t);return{endpoint:"Dot",anchor:"Continuous",paintStyle:{stroke:i,fill:i,radius:7,strokeWidth:1},isSource:!0,connector:["Flowchart",{stub:[40,60],gap:0,cornerRadius:5,alwaysRespectStubs:!0}],connectorStyle:{strokeWidth:2,stroke:"#999999",joinstyle:"round",outlineStroke:"white",outlineWidth:2},hoverPaintStyle:{fill:"#216477",stroke:"#216477"},connectorHoverStyle:{strokeWidth:3,stroke:"#216477",outlineWidth:5,outlineStroke:"white"},connectorOverlays:[["Label",{location:[3,-1.5],cssClass:"endpointSourceLabel"}]],dragOptions:{},uuid:t.id+"-"+e.name,parameters:{outcome:e}}},this.getActivity=function(e,t){return void 0===t&&(t=null),t||(t=this.workflowType.activities),$.grep(t,function(t){return t.id===e})[0]},this.updateConnections=function(t){for(var e=s.workflowType.id,i=0,o=s.workflowType.transitions;i<o.length;i++){var a=o[i],n=a.sourceActivityId+"-"+a.sourceOutcomeName,r=t.getEndpoint(n),c="activity-"+e+"-"+a.destinationActivityId;t.connect({source:r,target:c})}},this.updateCanvasHeight=function(){for(var t=$(this.container),e=0,i=0,o=0,a=t.find(".activity").toArray();o<a.length;o++){var n=a[o],r=$(n),c=r.position().top;e<c&&(e=c,i=r.height())}var s=e+i;s-(e+i)<=100&&(s+=100),t.height(Math.max(this.minCanvasHeight,s))}},__extends=this&&this.__extends||function(){var o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])};return function(t,e){function i(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}(),WorkflowEditor=function(a){function t(t,e,i,o,v){var p=a.call(this,t,e)||this;p.container=t,p.workflowType=e,p.deleteActivityPrompt=i,p.localId=o,p.getState=function(){for(var t=$(p.container).find(".activity"),e={id:p.workflowType.id,activities:[],transitions:[],removedActivities:p.workflowType.removedActivities},i=0;i<t.length;i++){var o=$(t[i]),a=o.data("activity-id"),n=o.data("activity-start"),r="Event"===o.data("activity-type"),c=o.position(),s=p.getActivity(a);e.activities.push({id:a,isStart:n,isEvent:r,outcomes:s.outcomes,x:c.left,y:c.top})}var l=p.jsPlumbInstance.getConnections();for(i=0;i<l.length;i++){var d=l[i],u=d.endpoints[0].getParameters().outcome.name,v=$(d.source).data("activity-id"),f=$(d.target).data("activity-id");e.transitions.push({sourceActivityId:v,destinationActivityId:f,sourceOutcomeName:u})}return e},p.serialize=function(){var t=p.getState();return JSON.stringify(t)},p.saveLocalState=function(){sessionStorage[p.localId]=p.serialize()},p.loadLocalState=function(){return JSON.parse(sessionStorage[p.localId])};var n=p;return jsPlumb.ready(function(){jsPlumb.importDefaults(p.getDefaults());var u=p.createJsPlumbInstance();u.bind("connection",function(t,e){var i=t.connection,o=i.getParameters().outcome;i.getOverlay("label").setLabel(o.displayName)});var e=p.getActivityElements();u.batch(function(){var d=p.workflowType;p.workflowType.id;if(v){var t=p.loadLocalState();t&&(p.workflowType=t)}e.each(function(t,e){var i=$(e),o=i.data("activity-id");if(-1<p.workflowType.removedActivities.indexOf(o))i.remove();else{var a=p.getActivity(o),n=p.getActivity(o,d.activities);if(v)if(null==a)a=n,p.workflowType.activities.push(a),a.x=50,a.y=50;else(function(t,e){if(t.length!=e.length)return!1;for(var i=0;i<t.length;i++){var o=t[i],a=e[i];if(o.name!=a.displayName||o.displayName!=a.displayName)return!1}return!0})(a.outcomes,n.outcomes)||(a.outcomes=n.outcomes),i.css({left:a.x,top:a.y}).toggleClass("activity-start",a.isStart).data("activity-start",a.isStart);u.draggable(e,{grid:[10,10],containment:!0,start:function(t){p.dragStart={left:t.e.screenX,top:t.e.screenY}},stop:function(t){p.hasDragged=p.dragStart.left!=t.e.screenX||p.dragStart.top!=t.e.screenY,p.updateCanvasHeight()}}),u.makeTarget(e,{dropOptions:{hoverClass:"hover"},anchor:"Continuous",endpoint:["Blank",{radius:8}]});for(var r=0,c=a.outcomes;r<c.length;r++){var s=c[r],l=p.getSourceEndpointOptions(a,s);u.addEndpoint(e,{connectorOverlays:[["Label",{label:s.displayName,cssClass:"connection-label"}]]},l)}}}),p.updateConnections(u),(e=p.getActivityElements()).show(),p.updateCanvasHeight()}),e.popover({trigger:"manual",html:!0,content:function(){var o=$(this),t=o.find(".activity-commands").clone().show(),e=t.find(".activity-start-action"),i=!0===o.data("activity-start"),a=o.data("activity-id");return e.attr("aria-pressed",o.data("activity-start")),e.toggleClass("active",i),t.on("click",".activity-start-action",function(t){t.preventDefault();var e=$(t.currentTarget);e.button("toggle");var i=e.is(".active");o.data("activity-start",i),o.toggleClass("activity-start",i)}),t.on("click",".activity-delete-action",function(t){t.preventDefault(),n.workflowType.removedActivities.push(a),u.remove(o),o.popover("dispose")}),t.on("click","[data-persist-workflow]",function(t){n.saveLocalState()}),t.get(0)}}),$(t).on("click",".activity",function(t){p.hasDragged?p.hasDragged=!1:(p.isPopoverVisible&&e.popover("hide"),$(t.currentTarget).popover("show"),$(".popover").off("click").on("click",function(t){t.stopPropagation()}),t.stopPropagation(),p.isPopoverVisible=!0)}),$(t).on("dblclick",".activity",function(t){var e=$(t.currentTarget);e.data("activity-has-editor")&&(p.saveLocalState(),e.find(".activity-edit-action").get(0).click())}),$("body").on("click",function(t){e.popover("hide"),p.isPopoverVisible=!1}),$("body").on("click","[data-persist-workflow]",function(t){p.saveLocalState()}),p.jsPlumbInstance=u}),p}return __extends(t,a),t}(WorkflowCanvas);$.fn.workflowEditor=function(){return this.each(function(t,e){var i=$(e),o=i.data("workflow-type"),a=i.data("workflow-delete-activity-prompt"),n=i.data("workflow-local-id"),r=i.data("workflow-load-local-state");o.removedActivities=o.removedActivities||[],i.data("workflowEditor",new WorkflowEditor(e,o,a,n,r))}),this},$(document).ready(function(){var o=$(".workflow-canvas").workflowEditor().data("workflowEditor");$("#workflowEditorForm").on("submit",function(t,e){var i=o.serialize();$("#workflowStateInput").val(i)})});
